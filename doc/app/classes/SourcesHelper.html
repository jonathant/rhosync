<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: SourcesHelper</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">SourcesHelper</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/helpers/sources_helper_rb.html">
                app/helpers/sources_helper.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000168">build_object_values</a>&nbsp;&nbsp;
      <a href="#M000158">check_access</a>&nbsp;&nbsp;
      <a href="#M000166">cleanup_update_type</a>&nbsp;&nbsp;
      <a href="#M000160">clear_pending_records</a>&nbsp;&nbsp;
      <a href="#M000163">finalize_query_records</a>&nbsp;&nbsp;
      <a href="#M000164">make_name_value_list</a>&nbsp;&nbsp;
      <a href="#M000159">needs_refresh</a>&nbsp;&nbsp;
      <a href="#M000171">process_objects_for_client</a>&nbsp;&nbsp;
      <a href="#M000165">process_update_type</a>&nbsp;&nbsp;
      <a href="#M000167">qparms_from_object</a>&nbsp;&nbsp;
      <a href="#M000161">remove_dupe_pendings</a>&nbsp;&nbsp;
      <a href="#M000169">setup_client</a>&nbsp;&nbsp;
      <a href="#M000156">slog</a>&nbsp;&nbsp;
      <a href="#M000157">tlog</a>&nbsp;&nbsp;
      <a href="#M000162">update_pendings</a>&nbsp;&nbsp;
      <a href="#M000170">wrap_object_values</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000168" class="method-detail">
        <a name="M000168"></a>

        <div class="method-heading">
          <a href="#M000168" class="method-signature">
          <span class="method-name">build_object_values</span><span class="method-args">(utype=nil,client_id=nil,ack_token=nil,p_size=nil,conditions=nil,by_source=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000168-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000168-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 257</span>
257:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_object_values</span>(<span class="ruby-identifier">utype</span>=<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">client_id</span>=<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">ack_token</span>=<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">p_size</span>=<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">conditions</span>=<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">by_source</span>=<span class="ruby-keyword kw">nil</span>)
258:     <span class="ruby-comment cmt"># if client_id is provided, return only relevant objects for that client</span>
259:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">client_id</span>
260:       <span class="ruby-ivar">@client</span> = <span class="ruby-identifier">setup_client</span>(<span class="ruby-identifier">client_id</span>)
261:       <span class="ruby-ivar">@ack_token</span> = <span class="ruby-identifier">ack_token</span>
262:       <span class="ruby-ivar">@first_request</span>=<span class="ruby-keyword kw">false</span>
263:       <span class="ruby-ivar">@resend_token</span>=<span class="ruby-keyword kw">nil</span>
264: 
265:       <span class="ruby-comment cmt"># setup the conditions to handle the client request</span>
266:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@ack_token</span>
267:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[sources_controller] Received ack_token, ack_token: #{@ack_token.inspect}, new token: #{@token.inspect}&quot;</span>
268:       <span class="ruby-keyword kw">else</span>
269:         <span class="ruby-comment cmt"># get last token if available, otherwise it's the first request</span>
270:         <span class="ruby-comment cmt"># for a given source</span>
271:         <span class="ruby-ivar">@resend_token</span>=<span class="ruby-ivar">@client</span>.<span class="ruby-identifier">last_sync_token</span>
272:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@resend_token</span>.<span class="ruby-identifier">nil?</span>
273:           <span class="ruby-ivar">@first_request</span>=<span class="ruby-keyword kw">true</span>
274:           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;[sources_controller] First request for source&quot;</span>
275:         <span class="ruby-keyword kw">end</span>
276:       <span class="ruby-keyword kw">end</span>
277: 
278:       <span class="ruby-comment cmt"># generate new token for the next set of data</span>
279:       <span class="ruby-ivar">@token</span>=<span class="ruby-ivar">@resend_token</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@resend_token</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">get_new_token</span>
280:       <span class="ruby-comment cmt"># get the list of objects</span>
281:       <span class="ruby-comment cmt"># if this is a queued sync source and we are doing a refresh in the queue then wait for the queued sync to happen</span>
282:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">queuesync</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">needs_refresh</span>
283:         <span class="ruby-ivar">@object_values</span>=[]
284:       <span class="ruby-keyword kw">else</span>
285:         <span class="ruby-ivar">@object_values</span>=<span class="ruby-identifier">process_objects_for_client</span>(<span class="ruby-ivar">@source</span>,<span class="ruby-ivar">@client</span>,<span class="ruby-ivar">@token</span>,<span class="ruby-ivar">@ack_token</span>,<span class="ruby-ivar">@resend_token</span>,<span class="ruby-identifier">p_size</span>,<span class="ruby-ivar">@first_request</span>,<span class="ruby-identifier">by_source</span>)
286:       <span class="ruby-keyword kw">end</span>
287:       <span class="ruby-comment cmt"># set token depending on records returned</span>
288:       <span class="ruby-comment cmt"># if we sent zero records, we need to keep track so the client</span>
289:       <span class="ruby-comment cmt"># doesn't receive the last page again</span>
290:       <span class="ruby-ivar">@token</span>=<span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@object_values</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-ivar">@object_values</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
291: 
292:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[sources_controller] Finished processing objects for client,
293:       token: #{@token.inspect}, last_sync_token: #{@client.last_sync_token.inspect},
294:       updated_at: #{@client.updated_at}, object_values count: #{@object_values.length}&quot;</span>
295: 
296:       <span class="ruby-ivar">@total_count</span> = <span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">count_by_sql</span> <span class="ruby-node">&quot;SELECT COUNT(*) FROM object_values where user_id = #{current_user.id} and
297:                                                source_id = #{@source.id} and update_type = '#{utype}'&quot;</span>
298:     <span class="ruby-keyword kw">else</span>
299:       <span class="ruby-comment cmt"># no client_id, just show everything (optionally based on search conditions)</span>
300:       <span class="ruby-ivar">@object_values</span>=<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find_by_sql</span> <span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">get_sql_by_conditions</span>(<span class="ruby-identifier">utype</span>,<span class="ruby-ivar">@source</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">conditions</span>,<span class="ruby-identifier">by_source</span>)
301:     <span class="ruby-keyword kw">end</span>
302:     <span class="ruby-ivar">@object_values</span>.<span class="ruby-identifier">delete_if</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">value</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">&lt;</span><span class="ruby-value">1</span> } <span class="ruby-comment cmt"># don't send back blank or nil OAV triples</span>
303:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000158" class="method-detail">
        <a name="M000158"></a>

        <div class="method-heading">
          <a href="#M000158" class="method-signature">
          <span class="method-name">check_access</span><span class="method-args">(app)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
determines if the logged in users is a subscriber of the current app or
admin of the current app
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000158-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000158-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 26</span>
26:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_access</span>(<span class="ruby-identifier">app</span>)
27:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_user</span>
28:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Checking access for user &quot;</span><span class="ruby-operator">+</span><span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">login</span>
29:       <span class="ruby-identifier">matches_login</span>=<span class="ruby-identifier">app</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">login</span><span class="ruby-operator">==</span><span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">login</span>}
30:       <span class="ruby-identifier">matches_login</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">app</span>.<span class="ruby-identifier">administrations</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">user</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">login</span><span class="ruby-operator">==</span><span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">login</span> } <span class="ruby-comment cmt"># let the administrators of the app in as well</span>
31:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">app</span>.<span class="ruby-identifier">anonymous</span><span class="ruby-operator">==</span><span class="ruby-value">1</span>) <span class="ruby-keyword kw">and</span> (<span class="ruby-identifier">matches_login</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">matches_login</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
32:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>  <span class="ruby-value str">&quot;App is not anonymous and user was not found in subscriber list&quot;</span>
33:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-value str">&quot;User: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; not allowed access.&quot;</span>
34:         <span class="ruby-identifier">username</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>
35:         <span class="ruby-identifier">username</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;unknown&quot;</span>
36:         <span class="ruby-identifier">result</span>=<span class="ruby-keyword kw">nil</span>
37:       <span class="ruby-keyword kw">end</span>
38:     <span class="ruby-keyword kw">end</span>
39:     <span class="ruby-identifier">result</span>=<span class="ruby-ivar">@current_user</span>
40:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000166" class="method-detail">
        <a name="M000166"></a>

        <div class="method-heading">
          <a href="#M000166" class="method-signature">
          <span class="method-name">cleanup_update_type</span><span class="method-args">(utype,user_id=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
for query parameters (update type of qparms) they get cleared on subsequent
calls just for a given user (or credentials)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000166-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000166-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 217</span>
217:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleanup_update_type</span>(<span class="ruby-identifier">utype</span>,<span class="ruby-identifier">user_id</span>=<span class="ruby-keyword kw">nil</span>)
218:     <span class="ruby-identifier">cleanup_cmd</span>=<span class="ruby-value str">&quot;select distinct(object) as object from object_values where update_type='&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">utype</span> <span class="ruby-operator">+</span><span class="ruby-value str">&quot;'and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
219:     (<span class="ruby-identifier">cleanup_cmd</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; and user_id=&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user_id</span><span class="ruby-comment cmt"># if there is a user_id then just do delete and update based upon the records with that credential</span>
220:     <span class="ruby-identifier">objs</span>=<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">cleanup_cmd</span>)
221: 
222:     <span class="ruby-identifier">objs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
223:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">object</span>
224:         <span class="ruby-identifier">objvals</span>=<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find_all_by_object_and_update_type</span>(<span class="ruby-identifier">x</span>.<span class="ruby-identifier">object</span>,<span class="ruby-identifier">utype</span>) <span class="ruby-comment cmt"># this has all the attribute value pairs now</span>
225:         <span class="ruby-identifier">objvals</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">y</span><span class="ruby-operator">|</span>
226:           <span class="ruby-identifier">y</span>.<span class="ruby-identifier">destroy</span>
227:         <span class="ruby-keyword kw">end</span>
228:       <span class="ruby-keyword kw">else</span>
229:         <span class="ruby-identifier">msg</span>=<span class="ruby-value str">&quot;Missing object property on object value: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">inspect</span>.<span class="ruby-identifier">to_s</span>
230:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">msg</span>
231:         <span class="ruby-identifier">slog</span>(<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">msg</span>)
232:       <span class="ruby-keyword kw">end</span>
233:     <span class="ruby-keyword kw">end</span>
234:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000160" class="method-detail">
        <a name="M000160"></a>

        <div class="method-heading">
          <a href="#M000160" class="method-signature">
          <span class="method-name">clear_pending_records</span><span class="method-args">(credential)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
presence or absence of credential determines whether we are using a
&quot;per user sandbox&quot; or not
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000160-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000160-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 80</span>
80:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clear_pending_records</span>(<span class="ruby-identifier">credential</span>)
81:     <span class="ruby-identifier">delete_cmd</span>= <span class="ruby-value str">&quot;(update_type is null) and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
82:     (<span class="ruby-identifier">delete_cmd</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; and user_id=&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">credential</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">credential</span> <span class="ruby-comment cmt"># if there is a credential then just do delete and update based upon the records with that credential</span>
83:     <span class="ruby-keyword kw">begin</span>
84:       <span class="ruby-identifier">start</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">new</span>
85:       <span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">delete_all</span> <span class="ruby-identifier">delete_cmd</span>
86:       <span class="ruby-identifier">tlog</span>(<span class="ruby-identifier">start</span>,<span class="ruby-value str">&quot;delete&quot;</span>,<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">id</span>)
87:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>=<span class="ruby-operator">&gt;</span><span class="ruby-identifier">e</span>
88:       <span class="ruby-identifier">slog</span>(<span class="ruby-identifier">e</span>, <span class="ruby-value str">&quot;Failed to delete existing records &quot;</span>,<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">id</span>)
89:     <span class="ruby-keyword kw">end</span>
90:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000163" class="method-detail">
        <a name="M000163"></a>

        <div class="method-heading">
          <a href="#M000163" class="method-signature">
          <span class="method-name">finalize_query_records</span><span class="method-args">(credential)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
presence or absence of credential determines whether we are using a
&quot;per user sandbox&quot; or not
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000163-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000163-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 139</span>
139:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">finalize_query_records</span>(<span class="ruby-identifier">credential</span>)
140:     <span class="ruby-comment cmt"># first delete the existing query records</span>
141:     <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
142:       <span class="ruby-identifier">delete_cmd</span> = <span class="ruby-value str">&quot;(update_type is not null and update_type !='qparms') and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
143:       (<span class="ruby-identifier">delete_cmd</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; and user_id=&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">credential</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">credential</span> <span class="ruby-comment cmt"># if there is a credential then just do delete and update based upon the records with that credential</span>
144:       <span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">delete_all</span> <span class="ruby-identifier">delete_cmd</span>
145:       <span class="ruby-identifier">remove_dupe_pendings</span>(<span class="ruby-identifier">credential</span>)
146:       <span class="ruby-identifier">pending_to_query</span>=<span class="ruby-value str">&quot;update object_values set update_type='query',id=pending_id where update_type is null and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
147:       (<span class="ruby-identifier">pending_to_query</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; and user_id=&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">credential</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">credential</span>
148:       <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">pending_to_query</span>)
149:     <span class="ruby-keyword kw">end</span>
150:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">refreshtime</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">new</span> <span class="ruby-comment cmt"># timestamp</span>
151:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000164" class="method-detail">
        <a name="M000164"></a>

        <div class="method-heading">
          <a href="#M000164" class="method-signature">
          <span class="method-name">make_name_value_list</span><span class="method-args">(hash)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
helper function to come up with the string used for the name_value_list
name_value_list = [ { &quot;name&quot; =&gt; &quot;name&quot;,
&quot;value&quot; =&gt; &quot;rhomobile&quot; }, { &quot;name&quot; =&gt;
&quot;industry&quot;, &quot;value&quot; =&gt; &quot;software&quot; } ]
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000164-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000164-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 156</span>
156:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">make_name_value_list</span>(<span class="ruby-identifier">hash</span>)
157:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">hash</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">&gt;</span><span class="ruby-value">0</span>
158:       <span class="ruby-identifier">result</span>=<span class="ruby-value str">&quot;[&quot;</span>
159:       <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
160:         <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-value str">&quot;{'name' =&gt; '&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">x</span> <span class="ruby-operator">+</span><span class="ruby-value str">&quot;', 'value' =&gt; '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">x</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'},&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">x</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">&gt;</span><span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">x</span>]
161:       <span class="ruby-keyword kw">end</span>
162:       <span class="ruby-identifier">result</span>=<span class="ruby-identifier">result</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">result</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-comment cmt"># chop off last comma</span>
163:       <span class="ruby-identifier">result</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot;]&quot;</span>
164:     <span class="ruby-keyword kw">end</span>
165:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000159" class="method-detail">
        <a name="M000159"></a>

        <div class="method-heading">
          <a href="#M000159" class="method-signature">
          <span class="method-name">needs_refresh</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000159-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000159-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 42</span>
42:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">needs_refresh</span>
43:     <span class="ruby-identifier">result</span>=<span class="ruby-keyword kw">nil</span>
44:     <span class="ruby-comment cmt"># refresh if there are any updates to come</span>
45:     <span class="ruby-comment cmt"># INDEX: SHOULD USE BY_SOURCE_USER_TYPE</span>
46:     <span class="ruby-identifier">count_updates</span> = <span class="ruby-value str">&quot;select count(*) from object_values where update_type!='query' and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
47:     (<span class="ruby-identifier">count_updates</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; and user_id=&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">credential</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">credential</span><span class="ruby-comment cmt"># if there is a credential then just do delete and update based upon the records with that credential</span>
48:     <span class="ruby-keyword kw">if</span> (<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">count_by_sql</span> <span class="ruby-identifier">count_updates</span> ) <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
49:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Refreshing source #{name} #{id} because there are some non-query object values&quot;</span>
50:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
51:     <span class="ruby-keyword kw">end</span>
52: 
53:     <span class="ruby-comment cmt"># refresh if there is no data</span>
54:     <span class="ruby-comment cmt"># INDEX: SHOULD USE BY_SOURCE_USER_TYPE</span>
55:     <span class="ruby-identifier">count_query_objs</span>=<span class="ruby-value str">&quot;select count(*) from object_values where update_type='query' and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
56:     (<span class="ruby-identifier">count_query_objs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; and user_id=&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">credential</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">credential</span><span class="ruby-comment cmt"># if there is a credential then just do delete and update based upon the records with that credential</span>
57:     <span class="ruby-keyword kw">if</span> (<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">count_by_sql</span> <span class="ruby-identifier">count_query_objs</span> ) <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
58:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Refreshing source #{name} #{id} because there is no data stored in object values&quot;</span>
59:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
60:     <span class="ruby-keyword kw">end</span>
61: 
62:     <span class="ruby-comment cmt"># provided there is data....</span>
63:     <span class="ruby-comment cmt"># allow -1 to mean dont ever poll</span>
64:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-value">-1</span><span class="ruby-operator">==</span><span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">pollinterval</span>
65: 
66:     <span class="ruby-comment cmt"># allow 0 to mean always poll</span>
67:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-value">0</span><span class="ruby-operator">==</span><span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">pollinterval</span>
68: 
69:     <span class="ruby-comment cmt"># refresh is the data is old</span>
70:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">pollinterval</span><span class="ruby-operator">||=</span><span class="ruby-value">300</span> <span class="ruby-comment cmt"># 5 minute default if there's no pollinterval or its a bad value</span>
71:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">refreshtime</span> <span class="ruby-keyword kw">or</span> ((<span class="ruby-constant">Time</span>.<span class="ruby-identifier">new</span> <span class="ruby-operator">-</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">refreshtime</span>)<span class="ruby-operator">&gt;</span><span class="ruby-identifier">pollinterval</span>)
72:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Refreshing source #{name} #{id}  because the data is old: #{self.refreshtime}&quot;</span>
73:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
74:     <span class="ruby-keyword kw">end</span>
75: 
76:     <span class="ruby-keyword kw">false</span>  <span class="ruby-comment cmt"># return true of false (nil)</span>
77:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000171" class="method-detail">
        <a name="M000171"></a>

        <div class="method-heading">
          <a href="#M000171" class="method-signature">
          <span class="method-name">process_objects_for_client</span><span class="method-args">(source,client,token,ack_token,resend_token,p_size=nil,first_request=false,by_source=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
creates an object_value list for a given client based on that
client&#8216;s client_map records and the current state of the
object_values table since we do a delete_all in rhosync refresh, only
delete and insert are required
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000171-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000171-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 373</span>
373:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_objects_for_client</span>(<span class="ruby-identifier">source</span>,<span class="ruby-identifier">client</span>,<span class="ruby-identifier">token</span>,<span class="ruby-identifier">ack_token</span>,<span class="ruby-identifier">resend_token</span>,<span class="ruby-identifier">p_size</span>=<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">first_request</span>=<span class="ruby-keyword kw">false</span>,<span class="ruby-identifier">by_source</span>=<span class="ruby-keyword kw">nil</span>)
374: 
375:     <span class="ruby-comment cmt"># default page size of 10000</span>
376:     <span class="ruby-identifier">page_size</span> = <span class="ruby-identifier">p_size</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value">10000</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">p_size</span>.<span class="ruby-identifier">to_i</span>
377:     <span class="ruby-identifier">last_sync_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
378:     <span class="ruby-identifier">objs_to_return</span> = []
379:     <span class="ruby-identifier">by_source_condition</span> = <span class="ruby-node">&quot;and ov.source_id=#{source.id}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">by_source</span>
380:     <span class="ruby-identifier">user_condition</span> = <span class="ruby-node">&quot;= #{current_user.id}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
381:     <span class="ruby-identifier">user_condition</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;is NULL&quot;</span>
382: 
383:     <span class="ruby-comment cmt"># Setup the query conditions</span>
384:     <span class="ruby-identifier">object_value_conditions</span> = <span class="ruby-node">&quot;from object_values ov
385:                                 where ov.update_type='query'
386:                                 #{by_source_condition}
387:                                 and ov.user_id #{user_condition}
388:                                 and id not in
389:                                   (select object_value_id
390:                                    from client_maps
391:                                    where client_id='#{client.id}')
392:                                 order by ov.object,ov.id
393:                                 limit #{page_size}&quot;</span>
394: 
395:     <span class="ruby-identifier">object_value_query</span> = <span class="ruby-node">&quot;select * #{object_value_conditions}&quot;</span>
396: 
397:     <span class="ruby-comment cmt"># setup fields to insert in client_maps table</span>
398:     <span class="ruby-identifier">object_insert_query</span> = <span class="ruby-node">&quot;select '#{client.id}',id,'insert','#{token}' #{object_value_conditions}&quot;</span>
399: 
400:     <span class="ruby-comment cmt"># if we're resending the token, quickly return the results (inserts + deletes)</span>
401:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">resend_token</span>
402:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[sources_helper] resending token, resend_token: #{resend_token.inspect}&quot;</span>
403:       <span class="ruby-identifier">objs_to_return</span> = <span class="ruby-constant">ClientMap</span>.<span class="ruby-identifier">get_delete_objs_by_token_status</span>(<span class="ruby-identifier">client</span>.<span class="ruby-identifier">id</span>)
404:       <span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_attributes</span>({<span class="ruby-identifier">:updated_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">last_sync_time</span>, <span class="ruby-identifier">:last_sync_token</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">resend_token</span>})
405:       <span class="ruby-identifier">objs_to_return</span>.<span class="ruby-identifier">concat</span>( <span class="ruby-constant">ClientMap</span>.<span class="ruby-identifier">get_insert_objs_by_token_status</span>(<span class="ruby-identifier">client</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">resend_token</span>) )
406:     <span class="ruby-keyword kw">else</span>
407:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[sources_helper] ack_token: #{ack_token.inspect}, using new token: #{token.inspect}&quot;</span>
408: 
409:       <span class="ruby-comment cmt"># mark acknowledged token so we don't send it again</span>
410:       <span class="ruby-constant">ClientMap</span>.<span class="ruby-identifier">mark_objs_by_ack_token</span>(<span class="ruby-identifier">ack_token</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ack_token</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">ack_token</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
411: 
412:       <span class="ruby-comment cmt"># find delete records</span>
413:       <span class="ruby-identifier">objs_to_return</span>.<span class="ruby-identifier">concat</span>( <span class="ruby-constant">ClientMap</span>.<span class="ruby-identifier">get_delete_objs_for_client</span>(<span class="ruby-identifier">token</span>,<span class="ruby-identifier">page_size</span>,<span class="ruby-identifier">client</span>.<span class="ruby-identifier">id</span>) )
414:       
415:       <span class="ruby-comment cmt"># process temp objects for this client</span>
416:       <span class="ruby-constant">ClientMap</span>.<span class="ruby-identifier">process_create_objs_for_client</span>(<span class="ruby-identifier">client</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">source</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">token</span>)
417: 
418:       <span class="ruby-comment cmt"># find + save insert records</span>
419:       <span class="ruby-identifier">objs_to_insert</span> = <span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find_by_sql</span> <span class="ruby-identifier">object_value_query</span>
420:       <span class="ruby-constant">ClientMap</span>.<span class="ruby-identifier">insert_new_client_maps</span>(<span class="ruby-identifier">object_insert_query</span>)
421:       <span class="ruby-identifier">objs_to_insert</span>.<span class="ruby-identifier">collect!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">db_operation</span> = <span class="ruby-value str">'insert'</span>; <span class="ruby-identifier">x</span>}
422: 
423:       <span class="ruby-comment cmt"># Update the last updated time for this client</span>
424:       <span class="ruby-comment cmt"># to track the last sync time</span>
425:       <span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">:updated_at</span>, <span class="ruby-identifier">last_sync_time</span>)
426:       <span class="ruby-identifier">objs_to_return</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">objs_to_insert</span>)
427: 
428:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">token</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">objs_to_return</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
429:         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">:last_sync_token</span>, <span class="ruby-identifier">token</span>)
430:       <span class="ruby-keyword kw">else</span>
431:         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">:last_sync_token</span>, <span class="ruby-keyword kw">nil</span>)
432:       <span class="ruby-keyword kw">end</span>
433:     <span class="ruby-keyword kw">end</span>
434:     <span class="ruby-identifier">objs_to_return</span>
435:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000165" class="method-detail">
        <a name="M000165"></a>

        <div class="method-heading">
          <a href="#M000165" class="method-signature">
          <span class="method-name">process_update_type</span><span class="method-args">(utype)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000165-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000165-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 167</span>
167:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_update_type</span>(<span class="ruby-identifier">utype</span>)
168:     <span class="ruby-identifier">start</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">new</span> <span class="ruby-comment cmt"># start timing the operation</span>
169:     <span class="ruby-identifier">objs</span>=<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-value str">&quot;select distinct(object) as object,blob_file_name,blob_content_type,blob_file_size 
170:                                   from object_values where update_type='&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">utype</span> <span class="ruby-operator">+</span><span class="ruby-value str">&quot;'and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>)
171:     <span class="ruby-identifier">res</span> = <span class="ruby-keyword kw">nil</span>
172:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">objs</span> <span class="ruby-comment cmt"># check that we got some object values back</span>
173:       <span class="ruby-identifier">objs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
174:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Object returned is: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">inspect</span>.<span class="ruby-identifier">to_s</span>
175:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">object</span>
176:           <span class="ruby-identifier">objvals</span>=<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find_all_by_object_and_update_type</span>(<span class="ruby-identifier">x</span>.<span class="ruby-identifier">object</span>,<span class="ruby-identifier">utype</span>) <span class="ruby-comment cmt"># this has all the attribute value pairs now</span>
177:           <span class="ruby-identifier">attrvalues</span>={}
178:           <span class="ruby-identifier">attrvalues</span>[<span class="ruby-value str">&quot;id&quot;</span>]=<span class="ruby-identifier">x</span>.<span class="ruby-identifier">object</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">utype!</span>=<span class="ruby-value str">'create'</span> <span class="ruby-comment cmt"># setting the ID allows it be an update or delete</span>
179:           <span class="ruby-identifier">blob_file</span>=<span class="ruby-identifier">x</span>.<span class="ruby-identifier">blob_file_name</span>
180:           <span class="ruby-identifier">objvals</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">y</span><span class="ruby-operator">|</span>
181:             <span class="ruby-identifier">attrvalues</span>[<span class="ruby-identifier">y</span>.<span class="ruby-identifier">attrib</span>]=<span class="ruby-identifier">y</span>.<span class="ruby-identifier">value</span>
182:           <span class="ruby-keyword kw">end</span>
183:           <span class="ruby-comment cmt"># now attrvalues has the attribute values needed for the create,update,delete call</span>
184:           <span class="ruby-identifier">nvlist</span>=<span class="ruby-identifier">make_name_value_list</span>(<span class="ruby-identifier">attrvalues</span>)
185:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">source_adapter</span>
186:             <span class="ruby-identifier">name_value_list</span>=<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">nvlist</span>)
187:             <span class="ruby-identifier">params</span>=<span class="ruby-value str">&quot;(name_value_list&quot;</span><span class="ruby-operator">+</span> (<span class="ruby-identifier">x</span>.<span class="ruby-identifier">blob_file_name</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;,x.blob)&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;)&quot;</span>)
188:             <span class="ruby-identifier">cmd</span>=<span class="ruby-value str">&quot;source_adapter.&quot;</span> <span class="ruby-operator">+</span><span class="ruby-identifier">utype</span> <span class="ruby-operator">+</span><span class="ruby-identifier">params</span>
189:             <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-value str">&quot;Executing&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cmd</span>
190:             <span class="ruby-identifier">res</span> = <span class="ruby-keyword kw">nil</span>
191:             <span class="ruby-identifier">tmp_object</span> = <span class="ruby-constant">ClientTempObject</span>.<span class="ruby-identifier">find_by_temp_objectid</span>(<span class="ruby-identifier">x</span>.<span class="ruby-identifier">object</span>)
192:             <span class="ruby-keyword kw">begin</span>
193:               <span class="ruby-identifier">res</span> = <span class="ruby-identifier">eval</span> <span class="ruby-identifier">cmd</span>
194:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">res</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">tmp_object</span>
195:                 <span class="ruby-identifier">tmp_object</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">:objectid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">res</span>, <span class="ruby-identifier">:source_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>)
196:               <span class="ruby-keyword kw">end</span>
197:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SourceAdapterException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sae</span>
198:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp_object</span>
199:                 <span class="ruby-identifier">tmp_object</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{sae.class}:#{sae}&quot;</span>, <span class="ruby-identifier">:source_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>)
200:               <span class="ruby-keyword kw">end</span>
201:             <span class="ruby-keyword kw">end</span>
202:           <span class="ruby-keyword kw">end</span>
203:         <span class="ruby-keyword kw">else</span>
204:           <span class="ruby-identifier">msg</span>=<span class="ruby-value str">&quot;Missing object property on object value: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">inspect</span>.<span class="ruby-identifier">to_s</span>
205:           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">msg</span>
206:         <span class="ruby-keyword kw">end</span>
207:       <span class="ruby-keyword kw">end</span>
208:     <span class="ruby-keyword kw">else</span> <span class="ruby-comment cmt"># got no object values back</span>
209:       <span class="ruby-identifier">msg</span> <span class="ruby-value str">&quot;Failed to retrieve object values for &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">utype</span>
210:       <span class="ruby-identifier">slog</span>(<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">msg</span>)
211:     <span class="ruby-keyword kw">end</span>
212:     <span class="ruby-identifier">tlog</span>(<span class="ruby-identifier">start</span>,<span class="ruby-identifier">utype</span>,<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">id</span>) <span class="ruby-comment cmt"># log the time to perform the particular type of operation</span>
213:     <span class="ruby-identifier">res</span>
214:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000167" class="method-detail">
        <a name="M000167"></a>

        <div class="method-heading">
          <a href="#M000167" class="method-signature">
          <span class="method-name">qparms_from_object</span><span class="method-args">(user_id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
grab out all ObjectValues of updatetype=&quot;Create&quot; with object
named &quot;qparms&quot; for a specific user (user_id) and source (id) put
those together into a hash where each attrib is the key and each value is
the value return nil if there are no such objects
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000167-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000167-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 240</span>
240:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">qparms_from_object</span>(<span class="ruby-identifier">user_id</span>)
241:     <span class="ruby-identifier">qparms</span>=<span class="ruby-keyword kw">nil</span>
242:     <span class="ruby-identifier">attrs</span>=<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-value str">&quot;select * from object_values where object='qparms' and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-value str">&quot; and user_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">to_s</span>)
243:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">attrs</span>
244:       <span class="ruby-identifier">cleanup_update_type</span>(<span class="ruby-value str">'qparms'</span>,<span class="ruby-identifier">user_id</span>)
245:       <span class="ruby-identifier">qparms</span>={}
246:       <span class="ruby-identifier">attrs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
247:         <span class="ruby-identifier">qparms</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">attrib</span>]=<span class="ruby-identifier">x</span>.<span class="ruby-identifier">value</span>
248:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">update_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'create'</span>
249:           <span class="ruby-identifier">x</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value str">'update_type'</span>, <span class="ruby-value str">'qparms'</span>)
250:           <span class="ruby-identifier">x</span>.<span class="ruby-identifier">save</span>
251:         <span class="ruby-keyword kw">end</span>
252:       <span class="ruby-keyword kw">end</span>
253:     <span class="ruby-keyword kw">end</span>
254:     <span class="ruby-identifier">qparms</span>
255:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000161" class="method-detail">
        <a name="M000161"></a>

        <div class="method-heading">
          <a href="#M000161" class="method-signature">
          <span class="method-name">remove_dupe_pendings</span><span class="method-args">(credential)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
presence or absence of credential determines whether we are using a
&quot;per user sandbox&quot; or not
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000161-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000161-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 93</span>
 93:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove_dupe_pendings</span>(<span class="ruby-identifier">credential</span>)
 94:     <span class="ruby-identifier">pendings_cmd</span> = <span class="ruby-value str">&quot;select id,pending_id,object,attrib,value from object_values where update_type is null and source_id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
 95:     (<span class="ruby-identifier">pendings_cmd</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; and user_id=&quot;</span><span class="ruby-operator">+</span> <span class="ruby-identifier">credential</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">credential</span><span class="ruby-comment cmt"># if there is a credential then just do delete and update based upon the records with that credential</span>
 96:     <span class="ruby-identifier">pendings_cmd</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; order by pending_id&quot;</span>
 97:     <span class="ruby-identifier">objs</span>=<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find_by_sql</span> <span class="ruby-identifier">pendings_cmd</span>
 98:     <span class="ruby-identifier">prev</span>=<span class="ruby-keyword kw">nil</span>
 99:     <span class="ruby-identifier">objs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span> <span class="ruby-comment cmt"># remove dupes</span>
100:       <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">prev</span> <span class="ruby-keyword kw">and</span> (<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">pending_id</span><span class="ruby-operator">==</span><span class="ruby-identifier">prev</span>.<span class="ruby-identifier">pending_id</span>))
101:         <span class="ruby-identifier">dupemsg</span>=<span class="ruby-node">&quot;Deleting a duplicate pending ID: #{obj.pending_id.to_s} for OAV: #{obj.object.to_s},#{obj.attrib},#{obj.value})&quot;</span>
102:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">dupemsg</span>
103:         <span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">prev</span>.<span class="ruby-identifier">id</span>)
104:       <span class="ruby-keyword kw">end</span>
105:       <span class="ruby-identifier">prev</span>=<span class="ruby-identifier">obj</span>
106:     <span class="ruby-keyword kw">end</span>
107:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000169" class="method-detail">
        <a name="M000169"></a>

        <div class="method-heading">
          <a href="#M000169" class="method-signature">
          <span class="method-name">setup_client</span><span class="method-args">(client_id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000169-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000169-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 305</span>
305:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">setup_client</span>(<span class="ruby-identifier">client_id</span>)
306:     <span class="ruby-comment cmt"># setup client &amp; user association if it doesn't exist</span>
307:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">client_id</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">client_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">'client_id'</span>
308:       <span class="ruby-ivar">@client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">find_by_client_id</span>(<span class="ruby-identifier">client_id</span>)
309:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">nil?</span>
310:         <span class="ruby-ivar">@client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>
311:         <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">client_id</span> = <span class="ruby-identifier">client_id</span>
312:       <span class="ruby-keyword kw">end</span>
313:       <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">user</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">current_user</span>
314:       <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">save</span>
315:     <span class="ruby-keyword kw">end</span>
316:     <span class="ruby-ivar">@client</span>
317:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000156" class="method-detail">
        <a name="M000156"></a>

        <div class="method-heading">
          <a href="#M000156" class="method-signature">
          <span class="method-name">slog</span><span class="method-args">(e,msg,source_id=self.id,operation=nil,timing=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000156-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000156-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 3</span>
 3:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">slog</span>(<span class="ruby-identifier">e</span>,<span class="ruby-identifier">msg</span>,<span class="ruby-identifier">source_id</span>=<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">operation</span>=<span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">timing</span>=<span class="ruby-keyword kw">nil</span>)
 4:     <span class="ruby-keyword kw">begin</span>
 5:       <span class="ruby-identifier">l</span>=<span class="ruby-constant">SourceLog</span>.<span class="ruby-identifier">new</span>
 6:       <span class="ruby-identifier">l</span>.<span class="ruby-identifier">source_id</span>=<span class="ruby-identifier">source_id</span>
 7:       <span class="ruby-identifier">l</span>.<span class="ruby-identifier">error</span>=<span class="ruby-identifier">e</span>.<span class="ruby-identifier">inspect</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">nil?</span>
 8:       <span class="ruby-identifier">l</span>.<span class="ruby-identifier">error</span><span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>
 9:       <span class="ruby-identifier">l</span>.<span class="ruby-identifier">message</span>=<span class="ruby-identifier">msg</span>
10:       <span class="ruby-identifier">l</span>.<span class="ruby-identifier">operation</span>=<span class="ruby-identifier">operation</span>
11:       <span class="ruby-identifier">l</span>.<span class="ruby-identifier">timing</span>=<span class="ruby-identifier">timing</span>
12:       <span class="ruby-identifier">l</span>.<span class="ruby-identifier">save</span>
13:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>=<span class="ruby-operator">&gt;</span><span class="ruby-identifier">e</span>
14:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Failed to save source log message: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">e</span>
15:     <span class="ruby-keyword kw">end</span>
16:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000157" class="method-detail">
        <a name="M000157"></a>

        <div class="method-heading">
          <a href="#M000157" class="method-signature">
          <span class="method-name">tlog</span><span class="method-args">(start,operation,source_id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000157-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000157-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 18</span>
18:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tlog</span>(<span class="ruby-identifier">start</span>,<span class="ruby-identifier">operation</span>,<span class="ruby-identifier">source_id</span>)
19:     <span class="ruby-identifier">diff</span>=(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">new</span><span class="ruby-operator">-</span><span class="ruby-identifier">start</span>)
20:     <span class="ruby-identifier">slog</span>(<span class="ruby-keyword kw">nil</span>,<span class="ruby-value str">&quot;Timing: &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">diff</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-value str">&quot; seconds&quot;</span>,<span class="ruby-identifier">source_id</span>,<span class="ruby-identifier">operation</span>,<span class="ruby-identifier">diff</span>)
21:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000162" class="method-detail">
        <a name="M000162"></a>

        <div class="method-heading">
          <a href="#M000162" class="method-signature">
          <span class="method-name">update_pendings</span><span class="method-args">(credential,check_existing=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
this function performs pending to final convert one at a time and is robust
to failures to to do a pending to final for a single object
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000162-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000162-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 111</span>
111:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_pendings</span>(<span class="ruby-identifier">credential</span>,<span class="ruby-identifier">check_existing</span>=<span class="ruby-keyword kw">false</span>)
112:     <span class="ruby-identifier">conditions</span>=<span class="ruby-node">&quot;source_id=#{id}&quot;</span>
113:     <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; and user_id=#{credential.user.id}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">credential</span>
114:     <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
115:       <span class="ruby-identifier">objs</span>=<span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">:order=</span><span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:pending_id</span>
116:       <span class="ruby-identifier">current_ids</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_values</span> <span class="ruby-value str">&quot;select id from object_values where update_type='query'&quot;</span>
117:       <span class="ruby-identifier">objs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
118:         <span class="ruby-keyword kw">begin</span>
119:           <span class="ruby-comment cmt"># if check_existing, look for existing query object-attribute and delete it before replacement</span>
120:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">check_existing</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">current_ids</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">pending_id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
121:             <span class="ruby-identifier">existing</span> = <span class="ruby-constant">ObjectValue</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;object='#{obj.object}' and attrib='#{obj.attrib}' and 
122:                                                                 update_type='query' and #{conditions}&quot;</span>
123:             <span class="ruby-identifier">existing</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">existing</span>
124:             <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span> <span class="ruby-value str">&quot;update object_values set update_type='query',id=pending_id where
125:                                                    id=&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">obj</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-value str">&quot; and update_type is null&quot;</span>
126:             <span class="ruby-identifier">current_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">pending_id</span>.<span class="ruby-identifier">to_s</span>
127:           <span class="ruby-keyword kw">end</span>
128:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
129:           <span class="ruby-identifier">slog</span>(<span class="ruby-identifier">e</span>,<span class="ruby-value str">&quot;Failed to finalize object value (due to duplicate) for object &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">obj</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>,<span class="ruby-identifier">id</span>)
130:         <span class="ruby-keyword kw">end</span>
131:       <span class="ruby-keyword kw">end</span>
132:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">refreshtime</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">new</span>
133:       <span class="ruby-comment cmt"># TODO: This is bad... These collided but we can't update them, so we delete for now.</span>
134:       <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span> <span class="ruby-node">&quot;delete from object_values where update_type is NULL and #{conditions}&quot;</span>
135:     <span class="ruby-keyword kw">end</span>
136:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000170" class="method-detail">
        <a name="M000170"></a>

        <div class="method-heading">
          <a href="#M000170" class="method-signature">
          <span class="method-name">wrap_object_values</span><span class="method-args">(ovlist,token)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
wrap object-values by object and source
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000170-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000170-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/sources_helper.rb, line 320</span>
320:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wrap_object_values</span>(<span class="ruby-identifier">ovlist</span>,<span class="ruby-identifier">token</span>)
321:     <span class="ruby-ivar">@count</span> = <span class="ruby-value">0</span>
322:     <span class="ruby-identifier">list</span> = {}
323:     <span class="ruby-identifier">temp_count</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">client_temp_objects</span>.<span class="ruby-identifier">count</span>
324:     
325:     <span class="ruby-comment cmt"># process the ovlist (this will also include successful create objects)</span>
326:     <span class="ruby-identifier">ovlist</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ov</span><span class="ruby-operator">|</span>
327:       <span class="ruby-identifier">src_name</span> = <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">source</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">source</span>.<span class="ruby-identifier">name</span>
328:       <span class="ruby-identifier">src_name</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">'RhoDeleteSource'</span>
329:       <span class="ruby-identifier">obj_sym</span> = <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">object</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">object</span>.<span class="ruby-identifier">to_sym</span>
330:       <span class="ruby-identifier">obj_sym</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">:rho_del_obj</span>
331:       <span class="ruby-identifier">old_obj</span> = <span class="ruby-keyword kw">nil</span>
332:       <span class="ruby-identifier">av_hash</span> = { <span class="ruby-identifier">:i</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:d</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">db_operation</span>, <span class="ruby-identifier">:a</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">attrib</span>, <span class="ruby-identifier">:v</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">value</span> }
333:                   
334:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">temp_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
335:         <span class="ruby-comment cmt"># find the temp_obj that corresponds to the successful create</span>
336:         <span class="ruby-identifier">tmp_obj</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">client_temp_objects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:objectid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ov</span>.<span class="ruby-identifier">object</span>, <span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>})
337:       <span class="ruby-keyword kw">end</span>
338:       <span class="ruby-identifier">old_objid</span> = <span class="ruby-identifier">tmp_obj</span>.<span class="ruby-identifier">temp_objectid</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp_obj</span>
339:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">list</span>[<span class="ruby-identifier">src_name</span>]
340:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">list</span>[<span class="ruby-identifier">src_name</span>][<span class="ruby-identifier">obj_sym</span>]
341:           <span class="ruby-identifier">list</span>[<span class="ruby-identifier">src_name</span>][<span class="ruby-identifier">obj_sym</span>][<span class="ruby-identifier">:av</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">av_hash</span>
342:         <span class="ruby-keyword kw">else</span>
343:           <span class="ruby-identifier">list</span>[<span class="ruby-identifier">src_name</span>][<span class="ruby-identifier">obj_sym</span>] = { <span class="ruby-identifier">:oo</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_objid</span>, <span class="ruby-identifier">:av</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">av_hash</span>] }
344:           <span class="ruby-ivar">@count</span> <span class="ruby-operator">+=</span><span class="ruby-value">1</span>
345:         <span class="ruby-keyword kw">end</span>
346:       <span class="ruby-keyword kw">else</span>
347:         <span class="ruby-identifier">list</span>[<span class="ruby-identifier">src_name</span>] = { <span class="ruby-identifier">obj_sym</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:oo</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_objid</span>, <span class="ruby-identifier">:av</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">av_hash</span>] } }
348:       <span class="ruby-keyword kw">end</span>
349:     <span class="ruby-keyword kw">end</span>
350:     <span class="ruby-identifier">error_objs</span> = <span class="ruby-constant">ClientTempObject</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;client_id = '#{@client.client_id}' and error is not NULL&quot;</span>)
351:     
352:     <span class="ruby-identifier">error_objs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">err_obj</span><span class="ruby-operator">|</span>
353:       <span class="ruby-identifier">src_name</span> = <span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">source</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">source</span>.<span class="ruby-identifier">name</span>
354:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">list</span>[<span class="ruby-identifier">src_name</span>]
355:         <span class="ruby-identifier">list</span>[<span class="ruby-identifier">src_name</span>][<span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">temp_objectid</span>.<span class="ruby-identifier">to_sym</span>] = { <span class="ruby-identifier">:oo</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">temp_objectid</span>, <span class="ruby-identifier">:e</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">error</span> }
356:         <span class="ruby-ivar">@count</span> <span class="ruby-operator">+=</span><span class="ruby-value">1</span>
357:       <span class="ruby-keyword kw">else</span>
358:         <span class="ruby-identifier">list</span>[<span class="ruby-identifier">src_name</span>] = { <span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">temp_objectid</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:oo</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">temp_objectid</span>, <span class="ruby-identifier">:e</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">error</span> } }
359:         <span class="ruby-ivar">@count</span> <span class="ruby-operator">+=</span><span class="ruby-value">1</span>
360:       <span class="ruby-keyword kw">end</span>
361:       
362:       <span class="ruby-comment cmt"># make sure to set token, this may be the only object in the list</span>
363:       <span class="ruby-ivar">@token</span> = <span class="ruby-identifier">err_obj</span>.<span class="ruby-identifier">token</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@token</span>
364:     <span class="ruby-keyword kw">end</span>
365:     <span class="ruby-identifier">list</span>
366:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>